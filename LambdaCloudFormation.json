{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Resources":{
      "LambdaExecutionRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "lambda.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/",
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/SecretsManagerReadWrite",
               "arn:aws:iam::aws:policy/CloudWatchFullAccess",
               "arn:aws:iam::aws:policy/AWSLambda_FullAccess"
            ]
         }
      },
      "CFRestaurantListLambda":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "Handler":"com.fds.handler.restaurant.RestaurantListHandler::handleRequest",
            "Role":{
               "Fn::GetAtt":[
                  "LambdaExecutionRole",
                  "Arn"
               ]
            },
            "Code":{
               "S3Bucket":"fds-lambda-bucket",
               "S3Key":"FoodDeliveryStstem-1.0.0.jar"
            },
            "Runtime":"java11",
            "MemorySize":"512",
            "Timeout":"180",
            "Environment":{
               "Variables":{
                  "DB_ENDPOINT":"food-delivery-system-db.cujebrwa1paj.us-east-1.rds.amazonaws.com:3306/fds_db",
                  "DB_REGION":"us-east-1",
                  "DB_ADMIN_SECRET":"fds-db-creds"
               }
            }
         },
         "DependsOn":[
            "LambdaExecutionRole"
         ]
      },
      "CFRestaurantListLambdaPermission":{
         "Type":"AWS::Lambda::Permission",
         "Properties":{
            "Action":"lambda:invokeFunction",
            "FunctionName":{
               "Fn::GetAtt":[
                  "CFRestaurantListLambda",
                  "Arn"
               ]
            },
            "Principal":"apigateway.amazonaws.com",
            "SourceArn":{
               "Fn::Join":[
                  "",
                  [
                     "arn:aws:execute-api:",
                     {
                        "Ref":"AWS::Region"
                     },
                     ":",
                     {
                        "Ref":"AWS::AccountId"
                     },
                     ":",
                     {
                        "Ref":"CFRestaurantAPI"
                     },
                     "/*"
                  ]
               ]
            }
         }
      },
      "CFOrderDetailLambda":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "Handler":"com.fds.handler.restaurant.OrderDetailHandler::handleRequest",
            "Role":{
               "Fn::GetAtt":[
                  "LambdaExecutionRole",
                  "Arn"
               ]
            },
            "Code":{
               "S3Bucket":"uow-cw",
               "S3Key":"FoodDeliveryStstem-1.0.0.jar"
            },
            "Runtime":"java11",
            "MemorySize":"512",
            "Timeout":"180",
            "Environment":{
               "Variables":{
                  "DB_ENDPOINT":"food-delivery-system-db.cujebrwa1paj.us-east-1.rds.amazonaws.com:3306/fds_db",
                  "DB_REGION":"us-east-1",
                  "DB_ADMIN_SECRET":"fds-db-creds"
               }
            }
         },
         "DependsOn":[
            "LambdaExecutionRole"
         ]
      },
      "CFOrderDetailLambdaPermission":{
         "Type":"AWS::Lambda::Permission",
         "Properties":{
            "Action":"lambda:invokeFunction",
            "FunctionName":{
               "Fn::GetAtt":[
                  "CFOrderDetailLambda",
                  "Arn"
               ]
            },
            "Principal":"apigateway.amazonaws.com",
            "SourceArn":{
               "Fn::Join":[
                  "",
                  [
                     "arn:aws:execute-api:",
                     {
                        "Ref":"AWS::Region"
                     },
                     ":",
                     {
                        "Ref":"AWS::AccountId"
                     },
                     ":",
                     {
                        "Ref":"CFRestaurantAPI"
                     },
                     "/*"
                  ]
               ]
            }
         }
      },
      "CFRestaurantAPI":{
         "Type":"AWS::ApiGateway::RestApi",
         "Properties":{
            "Name":"RestaurantAPI"
         }
      },
      "CFRestaurantAPIRestaurantListResource":{
         "Type":"AWS::ApiGateway::Resource",
         "Properties":{
            "RestApiId":{
               "Ref":"CFRestaurantAPI"
            },
            "ParentId":{
               "Fn::GetAtt":[
                  "CFRestaurantAPI",
                  "RootResourceId"
               ]
            },
            "PathPart":"restaurants"
         },
         "DependsOn":[
            "CFRestaurantAPI"
         ]
      },
      "CFOrderResource":{
         "Type":"AWS::ApiGateway::Resource",
         "Properties":{
            "RestApiId":{
               "Ref":"CFRestaurantAPI"
            },
            "ParentId":{
               "Fn::GetAtt":[
                  "CFRestaurantAPI",
                  "RootResourceId"
               ]
            },
            "PathPart":"order"
         },
         "DependsOn":[
            "CFRestaurantAPI"
         ]
      },
      "CFOrderDetailResource":{
         "Type":"AWS::ApiGateway::Resource",
         "Properties":{
            "RestApiId":{
               "Ref":"CFRestaurantAPI"
            },
            "ParentId": {
               "Ref": "CFOrderResource"
            },
            "PathPart":"{orderId}"
         },
         "DependsOn":[
            "CFRestaurantAPI"
         ]
      },
      "CFRestaurantAPIResourceRestaurantListMethod":{
         "Type":"AWS::ApiGateway::Method",
         "Properties":{
            "AuthorizationType":"NONE",
            "HttpMethod":"GET",
            "ResourceId":{
               "Ref":"CFRestaurantAPIRestaurantListResource"
            },
            "RestApiId":{
               "Ref":"CFRestaurantAPI"
            },
            "Integration":{
               "Type":"AWS",
               "IntegrationHttpMethod":"POST",
               "IntegrationResponses":[
                  {
                     "StatusCode":200
                  }
               ],
               "Uri":{
                  "Fn::Join":[
                     "",
                     [
                        "arn:aws:apigateway:",
                        {
                           "Ref":"AWS::Region"
                        },
                        ":lambda:path/2015-03-31/functions/",
                        {
                           "Fn::GetAtt":[
                              "CFRestaurantListLambda",
                              "Arn"
                           ]
                        },
                        "/invocations"
                     ]
                  ]
               }
            },
            "MethodResponses":[
               {
                  "StatusCode":200
               }
            ]
         },
         "DependsOn":[
            "CFRestaurantListLambda",
            "CFRestaurantAPIRestaurantListResource",
            "CFRestaurantListLambdaPermission"
         ]
      },
      "CFRestaurantAPIResourceMethodOrderDetail":{
         "Type":"AWS::ApiGateway::Method",
         "Properties":{
            "AuthorizationType":"NONE",
            "HttpMethod":"GET",
            "RequestParameters": {
               "method.request.path.orderId": 1
            },
            "ResourceId":{
               "Ref":"CFOrderDetailResource"
            },
            "RestApiId":{
               "Ref":"CFRestaurantAPI"
            },
            "Integration":{
               "Type":"AWS_PROXY",
               "IntegrationHttpMethod":"POST",
               "RequestParameters": {
                  "integration.request.path.orderId": "method.request.path.orderId"
               },
               "IntegrationResponses":[
                  {
                     "StatusCode":200
                  }
               ],
               "Uri":{
                  "Fn::Join":[
                     "",
                     [
                        "arn:aws:apigateway:",
                        {
                           "Ref":"AWS::Region"
                        },
                        ":lambda:path/2015-03-31/functions/",
                        {
                           "Fn::GetAtt":[
                              "CFOrderDetailLambda",
                              "Arn"
                           ]
                        },
                        "/invocations"
                     ]
                  ]
               }
            },
            "MethodResponses":[
               {
                  "StatusCode":200
               }
            ]
         },
         "DependsOn":[
            "CFOrderDetailLambda",
            "CFOrderResource",
            "CFOrderDetailResource",
            "CFOrderDetailLambdaPermission"
         ]
      },
      "Deployment":{
         "Type":"AWS::ApiGateway::Deployment",
         "Properties":{
            "RestApiId":{
               "Ref":"CFRestaurantAPI"
            },
            "Description":"First Deployment",
            "StageName":"StagingStage"
         },
         "DependsOn":[
            "CFRestaurantAPIResourceRestaurantListMethod",
            "CFRestaurantAPIResourceMethodOrderDetail"
         ]
      }
   }
}